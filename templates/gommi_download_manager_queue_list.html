{% extends "base.html" %}
{% import "macro.html" as macros %}

{% block content %}
<style>
    /* 이 페이지에서만 전역 로딩 인디케이터 숨김 */
    #loading { display: none !important; }

    /* Metallic Theme Variables */
    :root {
        --metal-dark: #1a1a1a;
        --metal-surface: linear-gradient(145deg, #2d2d2d, #1a1a1a);
        --metal-border: #404040;
        --metal-text: #e0e0e0;
        --metal-text-muted: #888;
        --metal-highlight: #00bcd4; /* Cyan/Blue Neon */
        --metal-shadow: 0 4px 6px rgba(0,0,0,0.5);
    }

    /* Card Override */
    .card {
        background: var(--metal-surface) !important;
        border: 1px solid var(--metal-border) !important;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.6);
        color: var(--metal-text);
    }
    
    .card-header {
        background: rgba(0,0,0,0.2) !important;
        border-bottom: 1px solid var(--metal-border) !important;
        color: var(--metal-text);
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Table Override */
    .table {
        color: var(--metal-text) !important;
    }
    .table thead th {
        border-top: none;
        border-bottom: 2px solid var(--metal-border);
        color: var(--metal-text-muted);
        font-size: 0.85rem;
    }
    .table td {
        border-top: 1px solid rgba(255,255,255,0.05);
        vertical-align: middle;
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(255,255,255,0.02) !important;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(255,255,255,0.05) !important;
    }

    /* Buttons */
    .btn-outline-primary {
        color: var(--metal-highlight);
        border-color: var(--metal-highlight);
    }
    .btn-outline-primary:hover {
        background-color: var(--metal-highlight);
        color: #000;
        box-shadow: 0 0 10px var(--metal-highlight);
    }
    .btn-outline-danger {
        color: #ff5252;
        border-color: #ff5252;
    }
    .btn-outline-danger:hover {
        background-color: #ff5252;
        color: white;
        box-shadow: 0 0 10px #ff5252;
    }

    /* Badges */
    .badge {
        font-weight: 500;
        letter-spacing: 0.5px;
    }
    .badge-outline-secondary {
        border: 1px solid #666;
        color: #aaa;
        background: transparent;
    }
    .badge-outline-info {
        border: 1px solid var(--metal-highlight);
        color: var(--metal-highlight);
        background: transparent;
    }

    /* Progress Bar */
    .progress {
        background-color: rgba(0,0,0,0.5);
        border: 1px solid #333;
        border-radius: 10px;
        overflow: hidden;
    }
    .progress-bar {
        background: linear-gradient(90deg, #00acc1, #26c6da);
        box-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
        font-size: 0.8rem;
        line-height: 20px;
    }
</style>
<div id="gommi_download_manager_queue_list" class="mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">다운로드 목록</h5>
            <div>
                <button type="button" class="btn btn-sm btn-outline-danger mr-2" onclick="resetList()">
                    <i class="fa fa-trash"></i> 전체 삭제
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshList()">
                    <i class="fa fa-refresh"></i> 새로고침
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 5%">#</th>
                        <th style="width: 10%">요청</th>
                        <th style="width: 35%">제목/URL</th>
                        <th style="width: 10%">소스</th>
                        <th style="width: 15%">진행률</th>
                        <th style="width: 10%">속도</th>
                        <th style="width: 10%">상태</th>
                        <th style="width: 15%">작업</th>
                    </tr>
                </thead>
                <tbody id="download_list">
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            다운로드 항목이 없습니다.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<script src="/{{arg.package_name}}/static/{{arg.package_name}}.js"></script>
<script>
    console.log("Start Gommi Queue List JS");
    // alert("Check: JS Running");
    
    // Functions first
    function refreshList(silent) {
        // Try multiple URLs to find the correct one
        var attempts = [
            '/{{arg.package_name}}/ajax/{{arg.module_name}}/list',          // New Candidate
            '/{{arg.package_name}}/{{arg.module_name}}/ajax/list',          // Standard
            '/{{arg.package_name}}/{{arg.module_name}}/queue/ajax/list',    // Double Queue
            '/{{arg.package_name}}/queue/ajax/list'                         // Direct Queue
        ];
        
        function tryUrl(index) {
            if (index >= attempts.length) {
                console.error("All list fetch attempts failed");
                return;
            }
            
            var url = attempts[index];
            $.ajax({
                url: url,
                type: 'POST',
                dataType: 'json',
                data: {},
                global: !silent,  // Silent mode: suppress global loading indicator
                success: function(ret) {
                    if (ret.ret === 'success') {
                        renderList(ret.data || []);
                    } else {
                        // tryUrl(index + 1);
                    }
                },
                error: function(e) {
                     // console.warn("Failed URL:", url);
                     tryUrl(index + 1);
                }
            });
        }
        
        tryUrl(0);
    }

    function renderList(items) {
        var tbody = document.getElementById('download_list');
        if (!tbody) return;
        
        if (!items || items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">다운로드 항목이 없습니다.</td></tr>';
            return;
        }
        
        var html = '';
        items.forEach(function(item, index) {
            html += createDownloadRow(item, index + 1);
        });
        tbody.innerHTML = html;
    }
    
    function createDownloadRow(item, num) {
        var statusClass = {
            'pending': 'badge-secondary',
            'extracting': 'badge-info',
            'downloading': 'badge-primary',
            'completed': 'badge-success',
            'error': 'badge-danger',
            'cancelled': 'badge-warning',
            'paused': 'badge-warning'
        };
        
        var percent = (item.progress && !isNaN(item.progress)) ? item.progress : 0;
        var displayTitle = item.title ? item.title : (item.url || 'No Title');
        if (displayTitle.length > 50) displayTitle = displayTitle.substring(0, 50) + '...';
        
        return '<tr id="row_' + item.id + '">' +
            '<td>' + num + '</td>' +
            '<td><span class="badge badge-outline-secondary">' + (item.caller_plugin || 'User') + '</span></td>' +
            '<td title="' + (item.url || '') + '">' + 
                '<div style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + displayTitle + '</div>' + 
            '</td>' +
            '<td><span class="badge badge-outline-info">' + (item.source_type || 'auto') + '</span></td>' +
            '<td>' +
                '<div class="progress" style="height: 20px;">' +
                    '<div class="progress-bar" role="progressbar" style="width: ' + percent + '%;" aria-valuenow="' + percent + '" aria-valuemin="0" aria-valuemax="100">' + percent + '%</div>' +
                '</div>' +
            '</td>' +
            '<td>' + (item.speed || '-') + '</td>' +
            '<td><span class="badge ' + (statusClass[item.status] || 'badge-secondary') + '">' + (item.status || 'unknown') + '</span></td>' +
            '<td>' +
                (item.status === 'downloading' ? '<button class="btn btn-sm btn-warning" onclick="cancelDownload(\'' + item.id + '\')"><i class="fa fa-stop"></i></button>' : '') +
            '</td>' +
        '</tr>';
    }
    
    function updateDownloadRow(item) {
        var row = document.getElementById('row_' + item.id);
        if (row) {
            row.outerHTML = createDownloadRow(item, row.rowIndex);
        } else {
            refreshList();
        }
    }
    
    function cancelDownload(id) {
        $.ajax({
            url: '/{{arg.package_name}}/ajax/{{arg.module_name}}/cancel',  // Use new pattern
            type: 'POST',
            data: { id: id },
            dataType: 'json',
            success: function(ret) {
                if (ret.msg) {
                    $.notify('<strong>' + ret.msg + '</strong>', {type: 'success'});
                }
            }
        });
    }

    function resetList() {
        if (!confirm('정말 전체 목록을 삭제하시겠습니까? (진행 중인 작업도 취소됩니다)')) {
            return;
        }
        $.ajax({
            url: '/{{arg.package_name}}/ajax/{{arg.module_name}}/reset',
            type: 'POST',
            data: {},
            dataType: 'json',
            success: function(ret) {
                if (ret.msg) {
                    $.notify('<strong>' + ret.msg + '</strong>', {type: 'success'});
                }
                refreshList();
            }
        });
    }

    // Socket Init
    try {
        if (typeof io !== 'undefined') {
            // Namespace needs to match default_route_socketio_module attach param
            var socket = io.connect('/' + '{{ arg.package_name }}' + '/queue'); 
            socket.on('download_status', function(data) {
                updateDownloadRow(data);
            });
            
            socket.on('connect', function() {
                console.log('Socket connected!');
            });
        }
    } catch (e) {
        console.error('Socket.IO init error:', e);
    }
    
    // Initial Load
    $(document).ready(function() {
        console.log("OnReady: Refresh List");
        refreshList();
        
        // Auto Refresh logic (fallback for Socket.IO)
        setInterval(function() {
            // refreshList(); // 전체 갱신 보다는 상태만 가져오는게 좋지만, 일단 전체 갱신
            // 조용히 갱신 (Optional: modify refreshList to accept silent flag)
            
            // 단순하게 목록 갱신 호출
             refreshList(true); // Silent mode
        }, 5000); // 5초마다
    });
</script>
{% endblock %}
